<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carteirinha UTFPR</title>
  <link rel="manifest" href="manifest.json" />

  <style>
    :root {
      --utfpr-amarelo: #FFCC00;
      --utfpr-amarelo-escuro: #C7A200;
      --utfpr-preto: #000000;
      --radius: 10px;
      --fundo: #f5f5f5;
    }

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--fundo);
      color: var(--utfpr-preto);
      padding: 20px;
    }

    /* Cabeçalho institucional */
    .headerUTFPR {
      text-align: center;
      font-weight: bold;
      font-size: 22px;
      padding: 16px;
      margin-bottom: 25px;
      background: var(--utfpr-preto);
      color: var(--utfpr-amarelo);
      border-top: 10px solid var(--utfpr-amarelo);
      border-bottom: 10px solid var(--utfpr-amarelo);
    }

    .container {
      max-width: 520px;
      margin: 0 auto 20px;
      background: white;
      padding: 22px;
      border-radius: var(--radius);
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    input, select {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      border-radius: var(--radius);
      border: 2px solid #ccc;
      margin-bottom: 16px;
      transition: 0.2s;
    }

    input:focus {
      border-color: var(--utfpr-amarelo);
      outline: none;
      box-shadow: 0 0 6px rgba(255,204,0,0.6);
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      background: var(--utfpr-amarelo);
      color: black;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover { background: var(--utfpr-amarelo-escuro); }

    .btnSec { background: #555; color: white; margin-top: 8px; }
    .hidden { display: none; }

    /* Carteirinha oficial */
    .carteirinha {
      padding: 20px; border-radius: var(--radius);
      border: 6px solid var(--utfpr-preto); background: white;
      position: relative;
    }
    .carteirinha::before {
      content: ""; position: absolute; width: 100%; height: 10px;
      background: var(--utfpr-amarelo); top: 0; left: 0;
    }

    /* Ajuste foto do estudante */
    .fotoEstudante {
      display: block;
      margin: 0 auto 15px auto;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* Logo UTF */
    .logoUTF {
      display: block;
      margin: 0 auto 18px auto;
      width: 160px;
      height: auto;
    }

    .valido {
      margin-top: 20px; padding: 12px; background: #4caf50;
      color: white; font-weight: bold; border-radius: var(--radius);
      display: none; animation: fadeIn 0.3s ease;
    }

    .perfilItem {
      padding: 12px; margin-bottom: 12px; background: #f0f0f0;
      border-radius: var(--radius); border-left: 5px solid var(--utfpr-amarelo);
      display: flex; justify-content: space-between; align-items: center;
    }
    .perfilItem button { width: auto; padding: 7px 12px; font-size: 13px; border-radius: var(--radius); }
    .delBtn { background: #c62828; color: white; }

    .controls { display:flex; gap:8px; }
    .controls button { flex: 1; }

    /* POPUP */
    #popupAuth {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.6);
      display:none; justify-content:center; align-items:center;
    }
  </style>
</head>
<body>

  <div class="headerUTFPR">
    <img src="utf.png" alt="Logo UTFPR" style="height:60px; display:block; margin:0 auto;" />
  </div>

  <!-- FORMULÁRIO -->
  <div id="telaFormulario" class="container">
    <h2 style="text-align:center;">Gerar Carteirinha UTFPR</h2>

    <input id="formNome" placeholder="Nome completo" required />
    <input id="formCurso" placeholder="Curso" required />
    <input id="formCoef" placeholder="Coeficiente" type="number" step="0.01" required />
    <input id="formAno" placeholder="Ano de conclusão" type="number" required />
    <label><strong>Foto:</strong></label>
    <input id="formFoto" type="file" accept="image/*" required />

    <div style="display:flex; gap:10px;">
      <button onclick="gerarCarteirinha()">Gerar Carteirinha</button>
      <button class="btnSec" onclick="abrirPerfis()">Perfis</button>
    </div>
  </div>

  <!-- CARTEIRINHA -->
  <div id="telaCarteirinha" class="container hidden">
    <div class="carteirinha">

      <div class="logoArea" style="text-align:center; margin-bottom:18px;">
        <img src="utf.png" class="logoUTF" alt="Logo UTFPR" />
      </div>

      <img id="outFoto" class="fotoEstudante" />

      <p><strong>Nome:</strong> <span id="outNome"></span></p>
      <p><strong>Curso:</strong> <span id="outCurso"></span></p>
      <p><strong>Coeficiente:</strong> <span id="outCoef"></span></p>
      <p><strong>Conclusão:</strong> <span id="outAno"></span></p>

      <div style="display:flex; gap:10px; margin-top:12px;">
        <button onclick="validarDocumento()">Autenticar</button>
        <button class="btnSec" onclick="editarAtual()">Editar</button>
      </div>

      <div id="validoMsg" class="valido">Documento Autenticado ✔</div>
      <button class="btnSec" style="margin-top:10px" onclick="voltarFormulario()">Sair</button>

    </div>
  </div>

  <!-- LISTA DE PERFIS -->
  <div id="telaPerfis" class="container hidden">
    <h2 style="text-align:center;">Perfis Salvos</h2>
    <div id="listaPerfis"></div>

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button onclick="voltarFormulario()">Voltar</button>
      <button class="btnSec" onclick="limparPerfis()">Limpar todos</button>
    </div>
  </div>

  <!-- POPUP DE AUTENTICAÇÃO -->
  <div id="popupAuth">
    <div style="
      background:#fff; padding:20px; border-radius:12px;
      width:320px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);
    ">
      <h3>Autenticação</h3>

      <p><strong>Chave gerada:</strong></p>
      <p id="authKey" style="font-size:18px; font-weight:bold;"></p>

      <canvas id="qrCanvas" style="margin:15px auto; display:block;"></canvas>

      <button onclick="fecharPopup()" style="
        padding:10px 16px; margin-top:10px;
        background:#333; color:white; border:none; border-radius:8px;
        cursor:pointer; width:100%;
      ">Fechar</button>
    </div>
  </div>

  <script>
    const telaFormulario = document.getElementById('telaFormulario');
    const telaCarteirinha = document.getElementById('telaCarteirinha');
    const telaPerfis = document.getElementById('telaPerfis');
    const listaPerfis = document.getElementById('listaPerfis');

    const formNome = document.getElementById('formNome');
    const formCurso = document.getElementById('formCurso');
    const formCoef = document.getElementById('formCoef');
    const formAno = document.getElementById('formAno');
    const formFoto = document.getElementById('formFoto');

    const outFoto = document.getElementById('outFoto');
    const outNome = document.getElementById('outNome');
    const outCurso = document.getElementById('outCurso');
    const outCoef = document.getElementById('outCoef');
    const outAno = document.getElementById('outAno');
    const validoMsg = document.getElementById('validoMsg');

    let fotoBase64 = '';
    let perfilAtualIndex = null;

    function gerarCarteirinha() {
      const nome = formNome.value.trim();
      const curso = formCurso.value.trim();
      const coef = formCoef.value.trim();
      const ano = formAno.value.trim();
      const foto = formFoto.files[0];

      if (!nome || !curso || !coef || !ano || !foto) {
        alert('Preencha todos os campos.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        fotoBase64 = e.target.result;
        mostrarCarteirinha({ nome, curso, coef, ano, fotoBase64 });

        if (perfilAtualIndex === null)
          salvarPerfil({ nome, curso, coef, ano, fotoBase64 });
        else
          atualizarPerfil(perfilAtualIndex, { nome, curso, coef, ano, fotoBase64 });

        perfilAtualIndex = null;
        formFoto.value = '';
      };
      reader.readAsDataURL(foto);
    }

    function mostrarCarteirinha(p) {
      outFoto.src = p.fotoBase64;
      outNome.textContent = p.nome;
      outCurso.textContent = p.curso;
      outCoef.textContent = p.coef;
      outAno.textContent = p.ano;

      telaFormulario.classList.add('hidden');
      telaPerfis.classList.add('hidden');
      telaCarteirinha.classList.remove('hidden');
    }

    function listarPerfis() {
      return JSON.parse(localStorage.getItem('perfis') || '[]');
    }

    function salvarPerfil(perfil) {
      const lista = listarPerfis();
      lista.push(perfil);
      localStorage.setItem('perfis', JSON.stringify(lista));
    }

    function atualizarPerfil(i, perfil) {
      const lista = listarPerfis();
      if (i >= 0 && i < lista.length) {
        lista[i] = perfil;
        localStorage.setItem('perfis', JSON.stringify(lista));
      }
    }

    function excluirPerfil(i) {
      const lista = listarPerfis();
      lista.splice(i, 1);
      localStorage.setItem('perfis', JSON.stringify(lista));
      carregarPerfis();
    }

    function limparPerfis() {
      if (confirm('Apagar todos os perfis salvos?')) {
        localStorage.removeItem('perfis');
        carregarPerfis();
      }
    }

    /* GERAR QR CODE FAKE */
    function gerarQRCode(texto) {
      const canvas = document.getElementById("qrCanvas");
      const ctx = canvas.getContext("2d");
      const size = 200;

      canvas.width = size;
      canvas.height = size;

      ctx.fillStyle = "#FFF";
      ctx.fillRect(0, 0, size, size);

      ctx.fillStyle = "#000";

      for (let i = 0; i < 300; i++) {
        if (Math.random() > 0.5) {
          const x = Math.floor(Math.random() * size);
          const y = Math.floor(Math.random() * size);
          ctx.fillRect(x, y, 4, 4);
        }
      }
    }

    function validarDocumento() {
      validoMsg.style.display = 'block';
      setTimeout(() => validoMsg.style.display = 'none', 3000);

      // gerar chave aleatória
      const chave = "CHAVE-" + Math.floor(Math.random() * 90000 + 10000);
      document.getElementById("authKey").textContent = chave;

      gerarQRCode(chave);

      document.getElementById("popupAuth").style.display = "flex";
    }

    function fecharPopup() {
      document.getElementById("popupAuth").style.display = "none";
    }

    function voltarFormulario() {
      telaCarteirinha.classList.add('hidden');
      telaPerfis.classList.add('hidden');
      telaFormulario.classList.remove('hidden');
      perfilAtualIndex = null;
    }

    function abrirPerfis() {
      telaFormulario.classList.add('hidden');
      telaCarteirinha.classList.add('hidden');
      telaPerfis.classList.remove('hidden');
      carregarPerfis();
    }

    function carregarPerfis() {
      const lista = listarPerfis();
      listaPerfis.innerHTML = '';

      if (lista.length === 0) {
        listaPerfis.innerHTML = '<p style="text-align:center; color:#666">Nenhum perfil salvo.</p>';
        return;
      }

      lista.forEach((p, i) => {
        const item = document.createElement('div');
        item.className = 'perfilItem';

        const left = document.createElement('div');
        left.innerHTML = `
          <strong>${p.nome}</strong>
          <div style="font-size:13px;color:#333">
            ${p.curso} • ${p.ano}
          </div>`;

        const controls = document.createElement('div');
        controls.className = 'controls';

        const btnAbrir = document.createElement('button');
        btnAbrir.textContent = 'Abrir';
        btnAbrir.onclick = () => carregarPerfil(i);

        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.onclick = () => editarPerfil(i);

        const btnDel = document.createElement('button');
        btnDel.textContent = 'Excluir';
        btnDel.className = 'delBtn';
        btnDel.onclick = () => excluirPerfil(i);

        controls.appendChild(btnAbrir);
        controls.appendChild(btnEditar);
        controls.appendChild(btnDel);

        item.appendChild(left);
        item.appendChild(controls);

        listaPerfis.appendChild(item);
      });
    }

    function carregarPerfil(i) {
      const lista = listarPerfis();
      const p = lista[i];
      mostrarCarteirinha(p);
      perfilAtualIndex = i;
    }

    function editarPerfil(i) {
      const lista = listarPerfis();
      const p = lista[i];

      formNome.value = p.nome;
      formCurso.value = p.curso;
      formCoef.value = p.coef;
      formAno.value = p.ano;
      fotoBase64 = p.fotoBase64;
      perfilAtualIndex = i;

      telaPerfis.classList.add('hidden');
      telaCarteirinha.classList.add('hidden');
      telaFormulario.classList.remove('hidden');

      alert('Se não selecionar uma nova foto, a atual será mantida.');
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }

    window.addEventListener('DOMContentLoaded', carregarPerfis);
  </script>

</body>
</html>
